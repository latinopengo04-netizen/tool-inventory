<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tool Inventory System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
 <link href="styles.css" rel="stylesheet">
</head>
<body>

  <div class="connection-status" id="connectionStatus">
    <span class="status-indicator status-offline" id="statusDot"></span>
    <span id="statusText">Checking connection...</span>
  </div>

  <div class="container">
    <h1 class="mb-4">ðŸ”§ Tool Inventory System</h1>
    <div id="alertContainer"></div>

    <!-- Add Tool Section -->
    <div class="form-section">
      <h2>Add Tool</h2>
      <div class="row g-2">
        <div class="col-md-6">
          <input type="text" id="toolName" class="form-control" placeholder="Tool Name (e.g., Hammer, Drill)">
        </div>
        <div class="col-md-4">
          <input type="number" id="toolQty" class="form-control" placeholder="Quantity" min="1">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="addTool()">âž• Add Tool</button>
        </div>
      </div>
    </div>

    <!-- Inventory Search -->
    <div class="form-section">
      <h2>ðŸ“¦ Current Inventory</h2>
      <input type="text" id="searchInput" class="form-control mb-2" placeholder="ðŸ” Search tool name..." onkeyup="filterInventory()">
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="inventoryTable">
          <thead class="table-light">
            <tr>
              <th>Tool Name</th>
              <th>Quantity</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Release Tool Section -->
    <div class="form-section">
      <h2>ðŸ“¤ Release Tool to Site</h2>
      <div class="row g-2">
        <div class="col-md-4">
          <input type="text" id="releaseToolName" class="form-control" placeholder="Tool Name">
        </div>
        <div class="col-md-2">
          <input type="number" id="releaseQty" class="form-control" placeholder="Quantity" min="1">
        </div>
        <div class="col-md-3">
          <input type="text" id="siteLocation" class="form-control" placeholder="Site Location">
        </div>
        <div class="col-md-3">
          <input type="text" id="siteLeadman" class="form-control" placeholder="Site Leadman">
        </div>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <input type="date" id="releaseDate" class="form-control">
        </div>
        <div class="col-md-4">
          <button class="btn btn-success w-100" onclick="releaseTool()">âœ… Release Tool</button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-secondary w-100" onclick="downloadLog()">ðŸ“¥ Download Release Log</button>
        </div>
      </div>
    </div>

    <!-- Release Log Table -->
    <div class="form-section">
      <h2>ðŸ“‹ Release Log</h2>
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="releaseLogTable">
          <thead class="table-light">
            <tr>
              <th>Tool Name</th>
              <th>Quantity</th>
              <th>Site Location</th>
              <th>Leadman</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal" id="pinModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <h5 class="mb-3">Admin Authorization Required</h5>
        <p class="text-muted mb-3">Enter admin PIN to delete this release record:</p>
        <input type="password" id="pinInput" class="form-control mb-3" placeholder="Enter 4-digit PIN" maxlength="4">
        <div class="d-flex gap-2">
          <button class="btn btn-danger flex-fill" onclick="confirmDelete()">Delete</button>
          <button class="btn btn-secondary flex-fill" onclick="closePinModal()">Cancel</button>
        </div>
        <div id="pinError" class="text-danger mt-2" style="display:none;">Incorrect PIN. Please try again.</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // LocalStorage keys
    const INVENTORY_KEY = 'toolInventory';
    const RELEASE_LOG_KEY = 'releaseLog';
    const ADMIN_PIN = '1234'; // Change this to your desired PIN
    let deleteIndex = null;

    function getInventory() {
      const data = localStorage.getItem(INVENTORY_KEY);
      return data ? JSON.parse(data) : {};
    }

    function saveInventory(inventory) {
      localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
    }

    function getReleaseLog() {
      const data = localStorage.getItem(RELEASE_LOG_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveReleaseLog(log) {
      localStorage.setItem(RELEASE_LOG_KEY, JSON.stringify(log));
    }

    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.getElementById('alertContainer').appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    function loadInventory() {
      const inventory = getInventory();
      updateInventoryTable(inventory);
    }

    function updateInventoryTable(inventory) {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "";
      
      if (Object.keys(inventory).length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No tools in inventory</td></tr>';
        return;
      }
      
      for (const [name, qty] of Object.entries(inventory)) {
        const row = `<tr><td>${name}</td><td>${qty}</td></tr>`;
        tbody.innerHTML += row;
      }
    }

    function filterInventory() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#inventoryTable tbody tr");
      rows.forEach(row => {
        if (row.cells.length > 1) {
          const toolName = row.cells[0].textContent.toLowerCase();
          row.style.display = toolName.includes(search) ? "" : "none";
        }
      });
    }

    function addTool() {
      const name = document.getElementById("toolName").value.trim();
      const quantity = parseInt(document.getElementById("toolQty").value);
      
      if (!name || isNaN(quantity) || quantity <= 0) {
        showAlert("âš ï¸ Please enter a valid tool name and quantity.", 'warning');
        return;
      }

      const inventory = getInventory();
      
      if (inventory[name]) {
        inventory[name] += quantity;
      } else {
        inventory[name] = quantity;
      }
      
      saveInventory(inventory);
      showAlert(`âœ… ${name} added successfully! Quantity: ${quantity}`);
      
      document.getElementById("toolName").value = "";
      document.getElementById("toolQty").value = "";
      
      loadInventory();
    }

    function releaseTool() {
      const name = document.getElementById("releaseToolName").value.trim();
      const quantity = parseInt(document.getElementById("releaseQty").value);
      const location = document.getElementById("siteLocation").value.trim();
      const leadman = document.getElementById("siteLeadman").value.trim();
      const date = document.getElementById("releaseDate").value;

      if (!name || isNaN(quantity) || quantity <= 0 || !location || !leadman || !date) {
        showAlert("âš ï¸ Please fill out all fields correctly.", 'warning');
        return;
      }

      const inventory = getInventory();
      
      if (!inventory[name]) {
        showAlert(`âŒ Tool "${name}" not found in inventory`, 'danger');
        return;
      }
      
      if (inventory[name] < quantity) {
        showAlert(`âŒ Insufficient quantity. Available: ${inventory[name]}`, 'danger');
        return;
      }
      
      // Update inventory
      inventory[name] -= quantity;
      if (inventory[name] === 0) {
        delete inventory[name];
      }
      saveInventory(inventory);
      
      // Add to release log
      const releaseLog = getReleaseLog();
      releaseLog.unshift({
        name: name,
        qty: quantity,
        location: location,
        leadman: leadman,
        date: date,
        timestamp: new Date().toISOString()
      });
      saveReleaseLog(releaseLog);
      
      showAlert(`âœ… ${quantity} ${name}(s) released to ${location}`);
      
      document.getElementById("releaseToolName").value = "";
      document.getElementById("releaseQty").value = "";
      document.getElementById("siteLocation").value = "";
      document.getElementById("siteLeadman").value = "";
      document.getElementById("releaseDate").value = "";
      
      loadInventory();
      loadReleaseLog();
    }

    function loadReleaseLog() {
      const logs = getReleaseLog();
      updateReleaseLogTable(logs);
    }

    function updateReleaseLogTable(logs) {
      const tbody = document.querySelector("#releaseLogTable tbody");
      tbody.innerHTML = "";
      
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No release records yet</td></tr>';
        return;
      }
      
      logs.forEach((entry, index) => {
        const row = `<tr>
          <td>${entry.name}</td>
          <td>${entry.qty}</td>
          <td>${entry.location}</td>
          <td>${entry.leadman}</td>
          <td>${entry.date}</td>
          <td><button class="btn btn-danger btn-sm delete-btn" onclick="showPinModal(${index})">Delete</button></td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function showPinModal(index) {
      deleteIndex = index;
      document.getElementById('pinModal').classList.add('show');
      document.getElementById('pinInput').value = '';
      document.getElementById('pinError').style.display = 'none';
      document.getElementById('pinInput').focus();
    }

    function closePinModal() {
      document.getElementById('pinModal').classList.remove('show');
      deleteIndex = null;
    }

    function confirmDelete() {
      const enteredPin = document.getElementById('pinInput').value;
      
      if (enteredPin === ADMIN_PIN) {
        const logs = getReleaseLog();
        const deletedEntry = logs[deleteIndex];
        
        // Restore inventory
        const inventory = getInventory();
        if (inventory[deletedEntry.name]) {
          inventory[deletedEntry.name] += deletedEntry.qty;
        } else {
          inventory[deletedEntry.name] = deletedEntry.qty;
        }
        saveInventory(inventory);
        
        // Remove from log
        logs.splice(deleteIndex, 1);
        saveReleaseLog(logs);
        
        showAlert(`âœ… Release record deleted and ${deletedEntry.qty} ${deletedEntry.name}(s) returned to inventory`);
        loadInventory();
        loadReleaseLog();
        closePinModal();
      } else {
        document.getElementById('pinError').style.display = 'block';
      }
    }

    function downloadLog() {
      const logs = getReleaseLog();
      
      if (logs.length === 0) {
        showAlert('âš ï¸ No release records to download', 'warning');
        return;
      }
      
      // Create CSV content
      let csv = 'Tool Name,Quantity,Site Location,Site Leadman,Release Date\n';
      logs.forEach(entry => {
        csv += `"${entry.name}",${entry.qty},"${entry.location}","${entry.leadman}",${entry.date}\n`;
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `release_log_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showAlert('ðŸ“¥ Download started!');
    }

    // Initialize on page load
    window.onload = function() {
      console.log('ðŸš€ Tool Inventory System starting (Client-side mode)...');
      document.getElementById('statusDot').className = 'status-indicator status-online';
      document.getElementById('statusText').textContent = 'Local Storage';
      loadInventory();
      loadReleaseLog();
      showAlert('âœ… System ready! Data is saved in your browser. Default PIN: 1234', 'info');
      
      // Setup PIN input event listener
      const pinInput = document.getElementById('pinInput');
      if (pinInput) {
        pinInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            confirmDelete();
          }
        });
      }
    };
  </script>

</body>
</html>
