<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tool Inventory System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>

  <div class="connection-status" id="connectionStatus">
    <span class="status-indicator status-offline" id="statusDot"></span>
    <span id="statusText">Checking connection...</span>
  </div>

  <div class="container">
    <h1 class="mb-4">üîß Tool Inventory System</h1>
    <div id="alertContainer"></div>

    <!-- Add Tool Section -->
    <div class="form-section">
      <h2>Add Tool</h2>
      <div class="row g-2">
        <div class="col-md-6">
          <input type="text" id="toolName" class="form-control" placeholder="Tool Name (e.g., Hammer, Drill)">
        </div>
        <div class="col-md-4">
          <input type="number" id="toolQty" class="form-control" placeholder="Quantity" min="1">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="addTool()">‚ûï Add Tool</button>
        </div>
      </div>
    </div>

    <!-- Inventory Search -->
    <div class="form-section">
      <h2>üì¶ Current Inventory</h2>
      <input type="text" id="searchInput" class="form-control mb-2" placeholder="üîç Search tool name..." onkeyup="filterInventory()">
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="inventoryTable">
          <thead class="table-light">
            <tr>
              <th>Tool Name</th>
              <th>Quantity</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Release Tool Section -->
    <div class="form-section">
      <h2>üì§ Release Tool to Site</h2>
      <div class="row g-2">
        <div class="col-md-4">
          <input type="text" id="releaseToolName" class="form-control" placeholder="Tool Name">
        </div>
        <div class="col-md-2">
          <input type="number" id="releaseQty" class="form-control" placeholder="Quantity" min="1">
        </div>
        <div class="col-md-3">
          <input type="text" id="siteLocation" class="form-control" placeholder="Site Location">
        </div>
        <div class="col-md-3">
          <input type="text" id="siteLeadman" class="form-control" placeholder="Site Leadman">
        </div>
      </div>
     <div class="row g-2 mt-2">
        <div class="col-md-4">
          <input type="date" id="releaseDate" class="form-control">
        </div>
        <div class="col-md-4">
          <button class="btn btn-success w-100" onclick="releaseTool()">‚úÖ Release Tool</button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-secondary w-100" onclick="downloadLog()">üì• Download Release Log</button>
        </div>
      </div>
    </div>
    <!-- Release Log Table -->
    <div class="form-section">
      <h2>üìã Release Log</h2>
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="releaseLogTable">
          <thead class="table-light">
            <tr>
              <th>Tool Name</th>
              <th>Quantity</th>
              <th>Site Location</th>
              <th>Leadman</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:5000/api';
    let connectionStatus = false;

    function updateConnectionStatus(online) {
      connectionStatus = online;
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      
      if (online) {
        dot.className = 'status-indicator status-online';
        text.textContent = 'Connected';
      } else {
        dot.className = 'status-indicator status-offline';
        text.textContent = 'Disconnected';
      }
    }

    async function checkConnection() {
      try {
        const response = await fetch(`${API_BASE}/health`, { 
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        updateConnectionStatus(data.status === 'ok');
        return true;
      } catch (error) {
        console.error('Connection check failed:', error);
        updateConnectionStatus(false);
        return false;
      }
    }

    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.getElementById('alertContainer').appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    async function loadInventory() {
      try {
        const response = await fetch(`${API_BASE}/inventory`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const inventory = await response.json();
        updateInventoryTable(inventory);
      } catch (error) {
        console.error('Load inventory error:', error);
        showAlert('‚ö†Ô∏è Failed to load inventory. Make sure the server is running at http://localhost:5000', 'danger');
        updateConnectionStatus(false);
      }
    }

    function updateInventoryTable(inventory) {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "";
      
      if (Object.keys(inventory).length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No tools in inventory</td></tr>';
        return;
      }
      
      for (const [name, qty] of Object.entries(inventory)) {
        const row = `<tr><td>${name}</td><td>${qty}</td></tr>`;
        tbody.innerHTML += row;
      }
    }

    function filterInventory() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#inventoryTable tbody tr");
      rows.forEach(row => {
        if (row.cells.length > 1) {
          const toolName = row.cells[0].textContent.toLowerCase();
          row.style.display = toolName.includes(search) ? "" : "none";
        }
      });
    }

    async function addTool() {
      const name = document.getElementById("toolName").value.trim();
      const quantity = parseInt(document.getElementById("toolQty").value);
      
      if (!name || isNaN(quantity) || quantity <= 0) {
        showAlert("‚ö†Ô∏è Please enter a valid tool name and quantity.", 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/inventory`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, quantity })
        });

        const result = await response.json();
        
        if (response.ok) {
          showAlert(`‚úÖ ${name} added successfully! Quantity: ${quantity}`);
          document.getElementById("toolName").value = "";
          document.getElementById("toolQty").value = "";
          loadInventory();
        } else {
          showAlert('‚ùå ' + (result.error || 'Failed to add tool'), 'danger');
        }
      } catch (error) {
        console.error('Add tool error:', error);
        showAlert('‚ùå Error connecting to server: ' + error.message, 'danger');
      }
    }

    async function releaseTool() {
      const name = document.getElementById("releaseToolName").value.trim();
      const quantity = parseInt(document.getElementById("releaseQty").value);
      const location = document.getElementById("siteLocation").value.trim();
      const leadman = document.getElementById("siteLeadman").value.trim();
      const date = document.getElementById("releaseDate").value;

      if (!name || isNaN(quantity) || quantity <= 0 || !location || !leadman || !date) {
        showAlert("‚ö†Ô∏è Please fill out all fields correctly.", 'warning');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/release`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, quantity, location, leadman, date })
        });

        const result = await response.json();
        
        if (response.ok) {
          showAlert(`‚úÖ ${quantity} ${name}(s) released to ${location}`);
          document.getElementById("releaseToolName").value = "";
          document.getElementById("releaseQty").value = "";
          document.getElementById("siteLocation").value = "";
          document.getElementById("siteLeadman").value = "";
          document.getElementById("releaseDate").value = "";
          loadInventory();
          loadReleaseLog();
        } else {
          showAlert('‚ùå ' + (result.error || 'Failed to release tool'), 'danger');
        }
      } catch (error) {
        console.error('Release tool error:', error);
        showAlert('‚ùå Error connecting to server: ' + error.message, 'danger');
      }
    }

    async function loadReleaseLog() {
      try {
        const response = await fetch(`${API_BASE}/release-log`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const logs = await response.json();
        updateReleaseLogTable(logs);
      } catch (error) {
        console.error('Load release log error:', error);
        showAlert('‚ö†Ô∏è Failed to load release log', 'warning');
      }
    }

    function updateReleaseLogTable(logs) {
      const tbody = document.querySelector("#releaseLogTable tbody");
      tbody.innerHTML = "";
      
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No release records yet</td></tr>';
        return;
      }
      
      logs.forEach(entry => {
        const row = `<tr>
          <td>${entry.name}</td>
          <td>${entry.qty}</td>
          <td>${entry.location}</td>
          <td>${entry.leadman}</td>
          <td>${entry.date}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    async function downloadLog() {
      try {
        window.location.href = `${API_BASE}/download-log`;
        showAlert('üì• Download started!');
      } catch (error) {
        console.error('Download error:', error);
        showAlert('‚ùå Failed to download log: ' + error.message, 'danger');
      }
    }

    // Initialize on page load
    window.onload = async function() {
      console.log('üöÄ Tool Inventory System starting...');
      console.log('üì° API Base:', API_BASE);
      
      const connected = await checkConnection();
      
      if (connected) {
        loadInventory();
        loadReleaseLog();
      } else {
        showAlert('‚ö†Ô∏è Cannot connect to server. Please make sure:<br>1. Flask server is running: python tool_inventory_app.py<br>2. Server is accessible at http://localhost:5000', 'danger');
      }
      
      // Check connection every 10 seconds
      setInterval(checkConnection, 10000);
    };
  </script>
=======
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // LocalStorage keys
    const INVENTORY_KEY = 'toolInventory';
    const RELEASE_LOG_KEY = 'releaseLog';

    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.getElementById('alertContainer').appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    function getInventory() {
      const data = localStorage.getItem(INVENTORY_KEY);
      return data ? JSON.parse(data) : {};
    }

    function saveInventory(inventory) {
      localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
    }

    function getReleaseLog() {
      const data = localStorage.getItem(RELEASE_LOG_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveReleaseLog(log) {
      localStorage.setItem(RELEASE_LOG_KEY, JSON.stringify(log));
    }

    function loadInventory() {
      const inventory = getInventory();
      updateInventoryTable(inventory);
    }

    function updateInventoryTable(inventory) {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "";
      
      if (Object.keys(inventory).length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No tools in inventory</td></tr>';
        return;
      }
      
      for (const [name, qty] of Object.entries(inventory)) {
        const row = `<tr><td>${name}</td><td>${qty}</td></tr>`;
        tbody.innerHTML += row;
      }
    }

    function filterInventory() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#inventoryTable tbody tr");
      rows.forEach(row => {
        if (row.cells.length > 1) {
          const toolName = row.cells[0].textContent.toLowerCase();
          row.style.display = toolName.includes(search) ? "" : "none";
        }
      });
    }

    function addTool() {
      const name = document.getElementById("toolName").value.trim();
      const quantity = parseInt(document.getElementById("toolQty").value);
      
      if (!name || isNaN(quantity) || quantity <= 0) {
        showAlert("‚ö†Ô∏è Please enter a valid tool name and quantity.", 'warning');
        return;
      }

      const inventory = getInventory();
      
      if (inventory[name]) {
        inventory[name] += quantity;
      } else {
        inventory[name] = quantity;
      }
      
      saveInventory(inventory);
      showAlert(`‚úÖ ${name} added successfully! Quantity: ${quantity}`);
      
      document.getElementById("toolName").value = "";
      document.getElementById("toolQty").value = "";
      
      loadInventory();
    }

    function releaseTool() {
      const name = document.getElementById("releaseToolName").value.trim();
      const quantity = parseInt(document.getElementById("releaseQty").value);
      const location = document.getElementById("siteLocation").value.trim();
      const leadman = document.getElementById("siteLeadman").value.trim();
      const date = document.getElementById("releaseDate").value;

      if (!name || isNaN(quantity) || quantity <= 0 || !location || !leadman || !date) {
        showAlert("‚ö†Ô∏è Please fill out all fields correctly.", 'warning');
        return;
      }

      const inventory = getInventory();
      
      if (!inventory[name]) {
        showAlert(`‚ùå Tool "${name}" not found in inventory`, 'danger');
        return;
      }
      
      if (inventory[name] < quantity) {
        showAlert(`‚ùå Insufficient quantity. Available: ${inventory[name]}`, 'danger');
        return;
      }
      
      // Update inventory
      inventory[name] -= quantity;
      if (inventory[name] === 0) {
        delete inventory[name];
      }
      saveInventory(inventory);
      
      // Add to release log
      const releaseLog = getReleaseLog();
      releaseLog.unshift({
        name: name,
        qty: quantity,
        location: location,
        leadman: leadman,
        date: date,
        timestamp: new Date().toISOString()
      });
      saveReleaseLog(releaseLog);
      
      showAlert(`‚úÖ ${quantity} ${name}(s) released to ${location}`);
      
      document.getElementById("releaseToolName").value = "";
      document.getElementById("releaseQty").value = "";
      document.getElementById("siteLocation").value = "";
      document.getElementById("siteLeadman").value = "";
      document.getElementById("releaseDate").value = "";
      
      loadInventory();
      loadReleaseLog();
    }

    function loadReleaseLog() {
      const logs = getReleaseLog();
      updateReleaseLogTable(logs);
    }

    function updateReleaseLogTable(logs) {
      const tbody = document.querySelector("#releaseLogTable tbody");
      tbody.innerHTML = "";
      
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No release records yet</td></tr>';
        return;
      }
      
      logs.forEach(entry => {
        const row = `<tr>
          <td>${entry.name}</td>
          <td>${entry.qty}</td>
          <td>${entry.location}</td>
          <td>${entry.leadman}</td>
          <td>${entry.date}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function downloadLog() {
      const logs = getReleaseLog();
      
      if (logs.length === 0) {
        showAlert('‚ö†Ô∏è No release records to download', 'warning');
        return;
      }
      
      // Create CSV content
      let csv = 'Tool Name,Quantity,Site Location,Site Leadman,Release Date\n';
      logs.forEach(entry => {
        csv += `"${entry.name}",${entry.qty},"${entry.location}","${entry.leadman}",${entry.date}\n`;
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `release_log_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showAlert('üì• Download started!');
    }

    // Initialize on page load
    window.onload = function() {
      console.log('üöÄ Tool Inventory System starting (Client-side mode)...');
      document.getElementById('statusDot').className = 'status-indicator status-online';
      document.getElementById('statusText').textContent = 'Local Storage';
      loadInventory();
      loadReleaseLog();
      showAlert('‚úÖ System ready! Data is saved in your browser.', 'info');
    };
  </script>

</body>
</html>
